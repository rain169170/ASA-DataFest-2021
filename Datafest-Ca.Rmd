---
title: "Datafest-CA"
author: "Ting Wang"
date: '2021-04-28'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dbplyr)
library(tidyverse)
library(readxl)
library(lme4)
library(gtsummary)
#install.packages("randomForest")
#install.packages("caret")
#install.packages("e1071")
library(caret)
library(e1071)
library(randomForest)
library(ROCR)
```

##data wrangling
```{r,message=FALSE}
dataca <- read_csv("ca.csv")
attach(dataca)
head(dataca)
```
```{r}
useFENT <- na.omit(dataca$FENT_NMU) 
propFENT <- sum(useFENT == "1")/length(useFENT)

useBUP <- na.omit(dataca$BUP_NMU) 
propBUP <- sum(useBUP == "1")/length(useBUP)

useMETH <- na.omit(dataca$METH_NMU) 
propMETH <- sum(useMETH == "1")/length(useMETH)

useMORPH <- na.omit(dataca$MORPH_NMU) 
propMORPH <- sum(useMORPH == "1")/length(useMORPH)

useOXY <- na.omit(dataca$OXY_NMU) 
propOXY <- sum(useOXY == "1")/length(useOXY)

useOXYM <- na.omit(dataca$OXYM_NMU) 
propOXYM <- sum(useOXYM == "1")/length(useOXYM)

useTRAM <- na.omit(dataca$TRAM_NMU) 
propTRAM <- sum(useTRAM == "1")/length(useTRAM)

useTAP <- na.omit(dataca$TAP_NMU) 
propTAP <- sum(useTAP == "1")/length(useTAP)

useCOD <- na.omit(dataca$COD_NMU) 
propCOD <- sum(useCOD == "1")/length(useCOD)

useCOTC <- na.omit(dataca$COTC_NMU) 
propCOTC <- sum(useCOTC == "1")/length(useCOTC)

useHYD <- na.omit(dataca$HYD_NMU) 
propHYD <- sum(useHYD == "1")/length(useHYD)

useHYDM <- na.omit(dataca$HYDM_NMU) 
propHYDM <- sum(useHYDM == "1")/length(useHYDM)

useSUF <- na.omit(dataca$SUF_NMU) 
propSUF <- sum(useSUF == "1")/length(useSUF)

useSTIM <- na.omit(dataca$STIM_NMU) 
propSTIM <- sum(useSTIM == "1")/length(useSTIM)

useBENZ <- na.omit(dataca$BENZ_NMU) 
propBENZ <- sum(useBENZ == "1")/length(useBENZ)

useTHC <- na.omit(dataca$THC_NMU) 
propTHC <- sum(useTHC == "1")/length(useTHC)

prop <- c(propFENT, propBUP, propMETH, propMORPH, propOXY, propOXYM, propTRAM, propTAP, propCOD, propCOTC, propHYD, propHYDM, propSUF, propSTIM, propBENZ, propTHC)

drugs <- c('FENT', 'BUP','METH', 'MORPH', 'OXY', 'OXYM', 'TRAM', 'TAP', 'COD', 'COTC', 'HYD', 'HYDM', 'SUF', 'STIM', 'BENZ', 'THC')  

 
prop_misuse <- data.frame(drugs,prop)

plot_misuse<- ggplot(data=prop_misuse, aes(x=drugs, y=prop)) +
  geom_bar(stat="identity", width=0.5) + 
  labs(title="Proportion of Misuse by Drug Type in Canada",
        x ="Drug Type", y = "Proportion of Misuse")

plot_misuse

```

```{r}
dataca$FENT_NMU[is.na(dataca$FENT_NMU)] <- 0
dataca$BUP_NMU[is.na(dataca$BUP_NMU)] <- 0
dataca$METH_NMU[is.na(dataca$METH_NMU)] <- 0
dataca$MORPH_NMU[is.na(dataca$MORPH_NMU)] <- 0
dataca$OXY_NMU[is.na(dataca$OXY_NMU)] <- 0
dataca$OXYM_NMU[is.na(dataca$OXYM_NMU)] <- 0
dataca$TRAM_NMU[is.na(dataca$TRAM_NMU)] <- 0
dataca$TAP_NMU[is.na(dataca$TAP_NMU)] <- 0
dataca$COD_NMU[is.na(dataca$COD_NMU)] <- 0
dataca$COTC_NMU[is.na(dataca$COTC_NMU)] <- 0
dataca$HYD_NMU[is.na(dataca$HYD_NMU)] <- 0
dataca$HYDM_NMU[is.na(dataca$HYDM_NMU)] <- 0
dataca$SUF_NMU[is.na(dataca$SUF_NMU)] <- 0
dataca$STIM_NMU[is.na(dataca$STIM_NMU)] <- 0
dataca$BENZ_NMU[is.na(dataca$BENZ_NMU)] <- 0
dataca$THC_NMU[is.na(dataca$THC_NMU)] <- 0

dataca <- dataca %>%
  mutate(total_misuse =FENT_NMU + BUP_NMU + METH_NMU + MORPH_NMU + OXY_NMU + OXYM_NMU + TRAM_NMU + TAP_NMU + COD_NMU + COTC_NMU + HYD_NMU + HYDM_NMU + SUF_NMU + STIM_NMU +  BENZ_NMU + THC_NMU)
hist(dataca$total_misuse)
boxplot(dataca$total_misuse)
summary(dataca$total_misuse)
```

##modelling
```{r}
dataca$DEM_GENDER <- as.factor(dataca$DEM_GENDER)
dataca$DEM_ABOR <- as.factor(dataca$DEM_ABOR)
dataca$DEM_LOCATION <- as.factor(dataca$DEM_LOCATION)
dataca$DEM_MARITAL <- as.factor(dataca$DEM_MARITAL)
dataca$DEM_INCOME <- as.factor(dataca$DEM_INCOME)
dataca$DEM_EDU <- as.factor(dataca$DEM_EDU)
dataca$ALC_FREQ_USE <- as.factor(dataca$ALC_FREQ_USE)
dataca$TOB_FREQ_USE <- as.factor(dataca$TOB_FREQ_USE)
dataca$OTH_RX_DRUG_USE <- as.factor(dataca$OTH_RX_DRUG_USE)


model <- glm(total_misuse ~ gender + DEM_AGE10 + abor + location + marital + income + edu, family=poisson, data = dataca)
summary(model)
#sig var include age, abor, location (all besides NB, Nunavut and Northwest), marital (common law and seperated), income (160,000 or more and refer not to say), edu (trade and uni below bachelor)

#male more misuse 
#higher age, less misuse 
#being abor, more misuse 
#locations are sig, baseline is New found land and labrador 
#married is the lowest misuse, other types increase misuse 
#higher income, less misuse 
#higher edu, generally less misuse, most misuse for University certificate or diploma below the bachelor's level
```
```{r}
model2 <- glm(total_misuse ~ alcohol + cig + other_drug, family=poisson, data = dataca)
summary(model2)
#all significant
```
```{r}
#dataca$DEM_PREG[is.na(dataca$DEM_PREG)] <- 0
#dataca$DEM_HEALTH[is.na(dataca$DEM_HEALTH)] <- 0
#dataca$HEALTH_RX[is.na(dataca$HEALTH_RX)] <- 0

#dataca$DEM_PREG <- as.factor(dataca$DEM_PREG)
#dataca$DEM_HEALTH <- as.factor(dataca$DEM_HEALTH)
#dataca$HEALTH_RX <- as.factor(dataca$HEALTH_RX)

#dataca$PAIN_CHRONIC <- as.factor(dataca$PAIN_CHRONIC)
#dataca$PAIN_ACUTE <- as.factor(dataca$PAIN_ACUTE)

model3 <- glm(total_misuse ~ DEM_PREGMNTH + DEM_HEALTH + HEALTH_RX + HELP_SUB_USE + DRSHOP_NMU + DRSHOP_SELL + HPC_USE + HPC_SELL, family=poisson, data = dataca)
summary(model3)
#only help_sub_use sig, it significantly increases misuses 
```

```{r}

model4 <- glm(total_misuse ~ PAIN_CHRONIC + PAIN_ACUTE + MENT_ANX + MENT_ADHD + MENT_AUT + MENT_BIP + MENT_BPD + MENT_DEP + MENT_EAT + MENT_OCD + MENT_PANIC + MENT_PPD + MENT_PTSD + MENT_SCH + MENT_OTH + MENT_NONE, family=poisson, data = dataca)
summary(model4)

```
##visualization
```{r}
dataca %>% 
  ggplot(aes(x=location, y=total_misuse, col=gender))+
  geom_point()+
  theme_light()

dataca %>% 
  ggplot(aes(x=DEM_AGE10, y=total_misuse, col=gender))+
  geom_point()+
  theme_light()

dataca %>% 
  ggplot(aes(x=edu, y=total_misuse, col=gender))+
  geom_point()+
  theme_light()

dataca %>% 
  ggplot(aes(x=income, y=total_misuse, col=gender))+
  geom_point()+
  theme_light()

dataca%>%
  select(DEM_AGE10,DEM_GENDER)%>%
  tbl_summary(by=DEM_GENDER)%>%
  modify_header(label ~ "**Variable**")

```


##random forest
```{r}
dataca <- dataca%>% mutate(has_misuse = ifelse(total_misuse >= 1, 1, 0))
dataca$has_misuse <- as.factor(dataca$has_misuse)

# 80% train 20% test
smp_size <- floor(0.8 * nrow(dataca))
#set seed
set.seed(1234)
train_ind <- sample(seq_len(nrow(dataca)), size = smp_size)

train <- dataca[train_ind, ]
test <- dataca[-train_ind, ]
```

```{r}
set.seed(1234)
rf <-randomForest(has_misuse~ DEM_GENDER + DEM_AGE10 + DEM_ABOR + DEM_LOCATION + DEM_MARITAL + DEM_INCOME + DEM_EDU + ALC_FREQ_USE + TOB_FREQ_USE + OTH_RX_DRUG_USE + HELP_SUB_USE + PAIN_CHRONIC + PAIN_ACUTE + MENT_NONE,data=train, ntree=500) 

print(rf)
importance(rf)
varImpPlot(rf)
```

```{r}
pred1=predict(rf,type = "prob")
perf = prediction(pred1[,2], train$has_misuse)
# 1. Area under curve
auc = performance(perf, "auc")
#auc
# 2. True Positive and Negative Rate
pred3 = performance(perf, "tpr","fpr")
# 3. Plot the ROC curve
plot(pred3,main="ROC Curve for Random Forest",col=2,lwd=2)
abline(a=0,b=1,lwd=2,lty=2,col="gray")

pred <- predict(rf, newdata=test)
confusionMatrix(pred,test$has_misuse)
```





##useless stuff dont delete yet
```{r,eval=FALSE}
trControl <- trainControl(method = "cv",number = 10, search = "grid")

rfmodel <- train(total_misuse ~ DEM_GENDER + DEM_AGE10 + DEM_ABOR + DEM_LOCATION + DEM_MARITAL + DEM_INCOME + DEM_EDU + ALC_FREQ_USE + TOB_FREQ_USE + OTH_RX_DRUG_USE, data = train,
    method = "rf",
    metric = "RMSE",
    trControl = trControl)
#print(rfmodel)
pred <- predict(rfmodel, newdata= test)
#print(pred)

```



```{r,eval=FALSE}
#print(rfmodel)

#find best mtry 
set.seed(1234)
tuneGrid <- expand.grid(.mtry = c(1: 10))
rf_mtry <- train(total_misuse ~ gender + abor + location + marital + income + edu , data = train,
    method = "rf",
    metric = "RMSE",
    tuneGrid = tuneGrid,
    trControl = trControl,
    importance = TRUE,
    nodesize = 14,
    ntree = 300)

print(rf_mtry)

#find best maxnode
store_maxnode <- list()
tuneGrid <- expand.grid(.mtry = best_mtry)
for (maxnodes in c(5: 20)) {
    set.seed(1234)
    rf_maxnode <- train(total_misuse ~ gender + abor + location + marital + income + edu , data = train,
        method = "rf",
        metric = "RMSE",
        tuneGrid = tuneGrid,
        trControl = trControl,
        importance = TRUE,
        nodesize = 14,
        maxnodes = maxnodes,
        ntree = 300)
    current_iteration <- toString(maxnodes)
    store_maxnode[[current_iteration]] <- rf_maxnode
}
results_mtry <- resamples(store_maxnode)
summary(results_mtry)

#find best ntrees
store_maxtrees <- list()
for (ntree in c(250, 300, 350, 400, 450, 500, 550, 600, 800, 1000, 2000)) {
    set.seed(1234)
    rf_maxtrees <- train(total_misuse ~ gender + abor + location + marital + income + edu , data = train,
        method = "rf",
        metric = "RMSE",
        tuneGrid = tuneGrid,
        trControl = trControl,
        importance = TRUE,
        nodesize = 14,
        maxnodes = 24,
        ntree = ntree)
    key <- toString(ntree)
    store_maxtrees[[key]] <- rf_maxtrees
}
results_tree <- resamples(store_maxtrees)
summary(results_tree)


```




```{r,eval=FALSE}

dataca$DEM_PREG[is.na(dataca$DEM_PREG)] <- 0
dataca$DEM_HEALTH[is.na(dataca$DEM_HEALTH)] <- 0
dataca$HEALTH_RX[is.na(dataca$HEALTH_RX)] <- 0

dataca$DEM_PREG <- as.factor(dataca$DEM_PREG)
dataca$DEM_HEALTH <- as.factor(dataca$DEM_HEALTH)
dataca$HEALTH_RX <- as.factor(dataca$HEALTH_RX)

rf1 <-randomForest(has_misuse~DEM_GENDER + DEM_AGE10 + DEM_ABOR + DEM_LOCATION + DEM_MARITAL + DEM_INCOME + DEM_EDU + ALC_FREQ_USE + TOB_FREQ_USE + OTH_RX_DRUG_USE + DEM_PREG + DEM_HEALTH + HEALTH_RX + HELP_SUB_USE + DRSHOP_NMU + DRSHOP_SELL + HPC_USE + HPC_SELL,data=train, ntree=500) 
```















